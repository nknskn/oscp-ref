#!/bin/bash
URL="Here agent installer"
FILE="t.csv"

CMD="cd /tmp; curl -sSL ${URL} | bash"



## Main routine
while true; do
  while read r; do
    H=`echo ${r} | cut -d"," -f1`
    U=`echo ${r} | cut -d"," -f2`
    P=`echo ${r} | cut -d"," -f3`
    ping -W 2 -c 1 ${H} > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      expect << EOS
set timeout 5
log_user 0
spawn env LANG=C /usr/bin/ssh ${H} -l ${U} "${CMD}"
expect  {
  -glob "(yes/no)?" {
    send "yes\n"
    exp_continue
  }
  -re ".assword:" {
    send -- "${P}\n"
    interact
  }
}

expect {
    -regexp "\r\n" {
        send "exit\n"
        exit 0
    }
}
EOS
    fi
    sleep 10
  done < ${FILE}
  sleep 600
done
